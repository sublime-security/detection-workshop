name: 6. MetaStealer MacOS Malware
description: Hunt for MetaStealers DMG links
details: |
  ## Brief

  A MetaStealer MacOS malware delivery mechanism. 
  
  A PDF File mimicing legitimate business correspondence (Invoices, Remittance, RFQ, etc), often disguised to look like an Adobe application or file.
  
  The PDF links to a DMG file containing MetaStealer. MetaStealer is capable of stealing saved passwords,
  the contents of the keychain, and files. Some MetaStealer variants also have code designed to target Telegram and Meta apps.
  
  Recent samples have been observed to specifically target M1 & M2 users, a key difference from previous versions.

  ---

  ## Focus Areas
  - URL analysis
  - Link analysis
  - Attachment analysis
  - PDF analysis
  - DMG malware
  - Links to auto-downloaded files

hints:
  - markdown: |
      For this lab, we want to focus on messages with PDF attachments. We could use a snippet like the following to achieve this:
    source: |
      type.inbound
      and any(attachments,
        .file_type == "pdf"
      )
  
  - markdown: |
      To inspect all the URLs in the PDF containing a potential link to a "dmg" file, we could use a snippet like this:
    source: |
      type.inbound and
      any(attachments, 
        any(file.explode(.),
          any(.scan.url.urls, 
              strings.iends_with(.url, ".dmg")
          )
        )
      )

  - markdown: |
      To analyze files downloaded from the URLs in the PDF and look for DMG files, we could use something like this:
    source: |
      type.inbound
      and any(attachments,
        .file_type == "pdf"
        and any(file.explode(.),
                any(.scan.url.urls,
                    any(beta.linkanalysis(.).files_downloaded,
                        any(file.explode(.), .file_extension =~ "dmg")
                    )
                )
            ) 
        )
