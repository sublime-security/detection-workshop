name: VIP Impersonation
description: Search for VIP Impersonation
details: |
  # VIP Impersonation

  ## Focus Areas
  - Sender Email Characteristics
  - Recipient Role
  - NLU

  ---
  
  ## Brief

  The Chief Executives of Tyrell Corp are being impersonated!

  Emails are being sent to the finance department, requesting an invoice is paid ASAP.

  The emails originate from free email providers, .e.g Gmail, Hotmail.

  --- 

  ## Requirements

  - Create VIP Display Names List ($org_vip_display_names)
  - Create Finance Users' Emails List ($finance_users)
  
  ### VIPs

  - Arnold Grieves
  - Clara Smith
  - Bobby Robbins

  ### Finance User Emails

  - roger.stone@tyrellcorp.com

queries:
  full: |
    type.inbound and

    // Sender display name matches a VIP
    sender.display_name in $org_vip_display_names and 

    // Sender using free email provider
    sender.email.domain.domain in $free_email_providers and

    // Add known VIP emails as exceptions or trade-off with FTS
    sender.email.email not in ("arnold.grieves@live.com", "clarasmith@gmail.com") and 

    // Recipient is a Finance Department user
    any(recipients.to, .email.email in $finance_users) and 

    // ML analysis suggests this is BEC with high confidence
    any(ml.nlu_classifier(coalesce(body.html.display_text, body.plain.raw)).intents,
      .name in ("bec") and .confidence == "high"
    )
