name: 7. MetaStealer MacOS Malware
description: Hunt for MetaStealers DMG links
details: |
  ## Brief

  An MetaStealer MacOS malware delivery mechanism. 
  
  A PDF File mimicing legitimate business, (Invoices, Remittence, RFQ, etc) 
  
  The PDF links to a DMG file containing MetaStealer. MetaStealer is capable of stealing saved passwords,
  the contents of the keychain, and files. Some MetaStealer variants also have code designed to target Telegram and Meta apps.
  
  Recent samples have been observed to specifically be targeting M1 & M2 users, a key difference from previous versions

  ---

  ## Focus Areas
  - URI paths
  - Link analysis
  - Files downloaded functionality

hints:
  - markdown: |
      For this lab, we want to focus on emails with PDF attachments. We could use a snippet like the following to achieve this:
    source: |
      type.inbound
      and any(attachments,
        .file_type == "pdf"
      )
  
  - markdown: |
      To analyse all the links in the PDF containing dmg, we could use a snippet like this:
    source: |
      type.inbound and
      any(attachments, 
        any(file.explode(.),
          any(.scan.url.urls, 
              strings.icontains(.url, "dmg")
          )
        )
      )

  - markdown: |
      To analyse any files downloaded from the analysed links, we could use something like this, which matches on any encrypted zips:
    source: |
      type.inbound
      and any(attachments,
        .file_type == "pdf"
        and any(file.explode(.),
                any(.scan.url.urls,
                    strings.icontains(.url, "dmg")
                    and any(beta.linkanalysis(.).files_downloaded,
                            any(file.explode(.), .file_extension == "dmg")
                    )
                )
            ) 
        )
